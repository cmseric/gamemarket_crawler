{% extends "base.html" %}

{% block title %}数据表管理 - {{ super() }}{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col-md-8">
    <h2>
      <i class="fas fa-database me-2"></i>数据表管理
    </h2>
    <p class="text-muted">管理MySQL分表，查看表结构和数据统计</p>
  </div>
  <div class="col-md-4 text-md-end">
    <button class="btn btn-primary" onclick="refreshTables()">
      <i class="fas fa-sync me-1"></i>刷新表列表
    </button>
  </div>
</div>

{% if tables %}
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-table me-2"></i>可用数据表 ({{ tables|length }} 个)
        </h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>表名</th>
                <th>时间周期</th>
                <th>状态</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              {% for table in tables %}
              <tr>
                <td>
                  <strong>{{ table }}</strong>
                  {% if loop.first %}
                  <span class="badge bg-success ms-2">最新</span>
                  {% endif %}
                </td>
                <td>
                  {% if 'W' in table %}
                  <i class="fas fa-calendar-week me-1"></i>
                  {% set year = table.split('_')[-1][:4] %}
                  {% set week = table.split('_')[-1][5:] %}
                  {{ year }}年第{{ week }}周
                  {% elif table.split('_')[-1]|length == 6 %}
                  <i class="fas fa-calendar-alt me-1"></i>
                  {% set date_part = table.split('_')[-1] %}
                  {{ date_part[:4] }}年{{ date_part[4:] }}月
                  {% else %}
                  <i class="fas fa-question-circle me-1"></i>未知格式
                  {% endif %}
                </td>
                <td>
                  <span class="badge bg-success">正常</span>
                </td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewTableInfo('{{ table }}')">
                      <i class="fas fa-info-circle me-1"></i>信息
                    </button>
                    <button class="btn btn-outline-success" onclick="previewTableData('{{ table }}')">
                      <i class="fas fa-eye me-1"></i>预览
                    </button>
                    <button class="btn btn-outline-warning" onclick="exportTableData('{{ table }}')">
                      <i class="fas fa-download me-1"></i>导出
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 表统计信息 -->
<div class="row mt-4">
  <div class="col-md-4">
    <div class="card bg-primary text-white">
      <div class="card-body text-center">
        <h3 class="mb-2">{{ tables|length }}</h3>
        <p class="mb-0">数据表总数</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card bg-success text-white">
      <div class="card-body text-center">
        <h3 class="mb-2" id="totalRecords">-</h3>
        <p class="mb-0">总记录数</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card bg-info text-white">
      <div class="card-body text-center">
        <h3 class="mb-2" id="storageSize">-</h3>
        <p class="mb-0">存储大小</p>
      </div>
    </div>
  </div>
</div>

{% else %}
<!-- 无数据状态 -->
<div class="row">
  <div class="col-12">
    <div class="text-center py-5">
      <i class="fas fa-database fa-3x text-muted mb-3"></i>
      <h4 class="text-muted">暂无数据表</h4>
      <p class="text-muted">还没有创建任何数据表，请先运行爬虫生成数据</p>
      <a href="{{ url_for('index') }}" class="btn btn-primary">
        <i class="fas fa-home me-1"></i>返回首页
      </a>
    </div>
  </div>
</div>
{% endif %}

<!-- 表信息模态框 -->
<div class="modal fade" id="tableInfoModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tableInfoTitle">表信息</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="tableInfoBody">
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
          </div>
          <p class="mt-2">正在加载表信息...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>

<!-- 表数据预览模态框 -->
<div class="modal fade" id="tablePreviewModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tablePreviewTitle">数据预览</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="tablePreviewBody">
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
          </div>
          <p class="mt-2">正在加载数据...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // 页面加载后获取统计信息
  document.addEventListener('DOMContentLoaded', function () {
    loadTableStatistics();
  });

  function loadTableStatistics() {
    // 模拟统计数据（实际应该从API获取）
    setTimeout(() => {
      document.getElementById('totalRecords').textContent = '估算中...';
      document.getElementById('storageSize').textContent = '计算中...';

      // 模拟计算完成
      setTimeout(() => {
        document.getElementById('totalRecords').textContent = '12,345';
        document.getElementById('storageSize').textContent = '245 MB';
      }, 2000);
    }, 500);
  }

  function refreshTables() {
    showToast('正在刷新表列表...', 'info');
    location.reload();
  }

  function viewTableInfo(tableName) {
    const modal = new bootstrap.Modal(document.getElementById('tableInfoModal'));
    const title = document.getElementById('tableInfoTitle');
    const body = document.getElementById('tableInfoBody');

    title.textContent = `表信息 - ${tableName}`;
    body.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在加载表信息...</p>
            </div>
        `;

    modal.show();

    // 模拟加载表信息
    setTimeout(() => {
      body.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">基本信息</h6>
                        <table class="table table-sm">
                            <tr><td>表名</td><td>${tableName}</td></tr>
                            <tr><td>引擎</td><td>InnoDB</td></tr>
                            <tr><td>字符集</td><td>utf8mb4</td></tr>
                            <tr><td>创建时间</td><td>2024-01-15 08:30:00</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-success">统计信息</h6>
                        <table class="table table-sm">
                            <tr><td>记录数</td><td>1,234</td></tr>
                            <tr><td>数据大小</td><td>15.2 MB</td></tr>
                            <tr><td>索引大小</td><td>2.8 MB</td></tr>
                            <tr><td>最后更新</td><td>2024-01-20 14:25:30</td></tr>
                        </table>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6 class="text-info">表结构</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>字段名</th>
                                    <th>类型</th>
                                    <th>是否为空</th>
                                    <th>默认值</th>
                                    <th>备注</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>id</td><td>INT AUTO_INCREMENT</td><td>NO</td><td>NULL</td><td>主键</td></tr>
                                <tr><td>name</td><td>VARCHAR(255)</td><td>NO</td><td>NULL</td><td>游戏名称</td></tr>
                                <tr><td>app_id</td><td>VARCHAR(20)</td><td>YES</td><td>NULL</td><td>Steam应用ID</td></tr>
                                <tr><td>price</td><td>VARCHAR(50)</td><td>YES</td><td>NULL</td><td>价格</td></tr>
                                <tr><td>rank</td><td>INT</td><td>YES</td><td>NULL</td><td>排名</td></tr>
                                <tr><td>rank_type</td><td>VARCHAR(50)</td><td>YES</td><td>NULL</td><td>排行榜类型</td></tr>
                                <tr><td>crawl_date</td><td>DATE</td><td>NO</td><td>NULL</td><td>爬取日期</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
    }, 1500);
  }

  function previewTableData(tableName) {
    const modal = new bootstrap.Modal(document.getElementById('tablePreviewModal'));
    const title = document.getElementById('tablePreviewTitle');
    const body = document.getElementById('tablePreviewBody');

    title.textContent = `数据预览 - ${tableName}`;
    body.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在加载数据预览...</p>
            </div>
        `;

    modal.show();

    // 模拟加载数据预览
    setTimeout(() => {
      body.innerHTML = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">显示前10条记录</span>
                        <button class="btn btn-sm btn-primary" onclick="exportTableData('${tableName}')">
                            <i class="fas fa-download me-1"></i>导出完整数据
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>游戏名称</th>
                                <th>Steam ID</th>
                                <th>价格</th>
                                <th>排名</th>
                                <th>类型</th>
                                <th>爬取日期</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td>Counter-Strike 2</td>
                                <td>730</td>
                                <td>免费开玩</td>
                                <td>1</td>
                                <td>topsellers</td>
                                <td>2024-01-20</td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td>Grand Theft Auto V</td>
                                <td>271590</td>
                                <td>¥ 99</td>
                                <td>2</td>
                                <td>topsellers</td>
                                <td>2024-01-20</td>
                            </tr>
                            <tr>
                                <td>3</td>
                                <td>Cyberpunk 2077</td>
                                <td>1091500</td>
                                <td>¥ 298</td>
                                <td>3</td>
                                <td>topsellers</td>
                                <td>2024-01-20</td>
                            </tr>
                            <tr>
                                <td>4</td>
                                <td>Red Dead Redemption 2</td>
                                <td>1174180</td>
                                <td>¥ 249</td>
                                <td>4</td>
                                <td>topsellers</td>
                                <td>2024-01-20</td>
                            </tr>
                            <tr>
                                <td>5</td>
                                <td>Baldur's Gate 3</td>
                                <td>1086940</td>
                                <td>¥ 298</td>
                                <td>5</td>
                                <td>topsellers</td>
                                <td>2024-01-20</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="text-center text-muted">
                    <small>预览数据仅供参考，实际数据可能有所不同</small>
                </div>
            `;
    }, 1500);
  }

  function exportTableData(tableName) {
    showToast(`正在导出表 ${tableName} 的数据...`, 'info');

    // 模拟导出过程
    setTimeout(() => {
      showToast(`表 ${tableName} 导出完成！`, 'success');

      // 实际项目中这里应该触发下载
      const link = document.createElement('a');
      link.href = '#'; // 实际应该是导出API的URL
      link.download = `${tableName}_export.csv`;
      // link.click();
    }, 2000);
  }

  // 定义页面更新函数
  function updatePageData() {
    loadTableStatistics();
    showToast('数据已更新', 'success');
  }
</script>
{% endblock %}